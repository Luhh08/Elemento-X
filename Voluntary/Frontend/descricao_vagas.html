<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voluntary — Detalhes da Vaga</title>
  <link rel="stylesheet" href="css/descricao_vagas.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/notificacoes.css">
  <style>
    .carousel{position:relative;overflow:hidden;height:300px;display:flex;align-items:center;background:#000}
    @media (max-width: 900px){ .carousel{height:220px} }
    .carousel-track{display:flex;transition:transform .35s ease;height:100%}
    .carousel img{width:100%;height:100%;object-fit:cover;flex:0 0 100%;display:block}
  </style>
</head>
<body>
  <header class="site-header compact-header">
    <div class="header-compact">
      <button class="round-btn back-btn" id="btnBack" type="button" aria-label="Voltar">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <div class="header-actions">
        <div class="notification-wrapper" id="notificationWrapper">
          <button id="notifBtn" class="round-btn bell-btn" type="button" title="Notificações">
            <i class="fa-solid fa-bell"></i>
            <span class="notification-count"></span>
          </button>
          <div class="notif-panel" id="notifPanel">
            <div class="notif-header">Notificações</div>
            <p class="notif-empty">Carregando...</p>
          </div>
        </div>
        <button class="round-btn avatar-btn" id="menuToggle" type="button" aria-label="Abrir menu">
          <img src="img/default-avatar.jpg" alt="Menu">
        </button>
      </div>
    </div>
  </header>

  <div class="nav-drawer" id="navDrawer">
    <div class="drawer-inner">
      <button class="close-drawer" id="closeDrawer" type="button" aria-label="Fechar menu">&times;</button>
      <h2 class="drawer-title">Voluntary</h2>
      <nav id="drawerMenu" class="drawer-menu"></nav>
    </div>
  </div>
  <div class="drawer-overlay" id="drawerOverlay"></div>


  <main class="page">
    <article class="job-card">
      <section class="gallery">
        <div class="carousel" id="carousel">
          <button class="carousel-btn left" id="prevBtn">‹</button>
          <div class="carousel-track" id="carouselTrack"></div>
          <button class="carousel-btn right" id="nextBtn">›</button>
        </div>
      </section>

      <section class="content">
        <div class="content-header">
          <h1 id="jobTitle" class="job-title">Vaga</h1>
          <div id="companyProfile" class="company-mini">
            <img id="companyAvatar" class="company-avatar" src="img/default-company.png" alt="Logo da empresa">
            <div class="company-mini-info">
              <span id="companyName" class="company-name">Nome da empresa</span>
              <a id="companyLink" class="company-link" href="#" target="_blank" rel="noopener" hidden>Ver perfil</a>
            </div>
          </div>

          <div class="job-actions">
            <button id="reportBtn" class="btn pill danger">Denunciar</button>
            <button id="editBtn" class="btn pill">Editar vaga</button>
            <button id="deleteBtn" class="btn pill danger-outline">Excluir Vaga</button>
          </div>
        </div>

        <span id="statusBadge" class="status-badge">—</span>

        <p class="job-desc" id="jobDesc">Descrição_vaga</p>

        <div class="meta-row">
          <div class="left-meta">
            <h3>Tags</h3>
            <div class="tags" id="tagsList"></div>

            <div class="info-block">
              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-clock"></i></div>
                <div>
                  <div class="info-title">Horário</div>
                  <div class="info-text"><span id="jobTurno">—</span></div>
                </div>
              </div>

              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-calendar"></i></div>
                <div>
                  <div class="info-title">Período</div>
                  <div class="info-text"><span id="jobDateInicio">—</span> – <span id="jobDateFim">—</span></div>
                </div>
              </div>

              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-map"></i></div>
                <div>
                  <div class="info-title">Localização</div>
                  <div class="info-text" id="jobLocal">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- painel de aplicação -->
        <div class="apply-panel">
          <div class="apply-note">
            Ao clicar no botão de aplicar vaga, os seus dados serão enviados para a empresa
          </div>
          <div class="apply-row">
            <button id="applyBtn" data-vaga-id="" class="apply-btn">Aplicar</button>
          </div>
        </div>
      </section>
    </article>

    <aside class="applications" id="applicationsPanel" aria-hidden="true">
      <h4>Candidaturas</h4>
      <ul id="applicationsList"></ul>
      <button id="closeApps" class="small-btn">Fechar</button>
    </aside>
  </main>

  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Denunciar vaga</h3>
      <p>Explique o motivo da denúncia (opcional):</p>
      <textarea id="reportText" rows="5" placeholder="Motivo..."></textarea>
      <div class="modal-actions">
        <button class="small-btn" data-close>Cancelar</button>
        <button class="small-btn primary">Enviar</button>
      </div>
    </div>
  </div>

  <div id="confirmDelete" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Excluir vaga</h3>
      <p>Você tem certeza que quer excluir esta vaga? Essa ação não pode ser desfeita.</p>
      <div class="modal-actions">
        <button class="small-btn" data-close>Cancelar</button>
        <button id="confirmDeleteBtn" class="small-btn danger">Excluir</button>
      </div>
    </div>
  </div>

  <script>
(function () {
  const DEFAULT_VAGA_IMG = "img/default-vaga.jpg";
  const DEFAULT_COMPANY_IMG = "img/default-company.png";
  const API_PREFIX = (typeof window !== "undefined" && window.API_BASE) ? window.API_BASE : "/api";

  const qs = new URLSearchParams(location.search);
  const live = qs.get("live") === "1";
  const vagaId = qs.get("id");
  if (live) document.body.classList.add("live");

  const btnEdit   = document.getElementById("editBtn");
  const btnDelete = document.getElementById("deleteBtn");
  const btnReport = document.getElementById("reportBtn");

  [btnEdit, btnDelete].forEach(b => { if (b) b.style.display = "none"; });

  function getOwnerIdFromVaga(v){
    return v?.empresaId || v?.empresa?.id || v?.ownerId || v?.usuarioId || null;
  }
  function getLoggedEmpresaId(){
    const tipo = (localStorage.getItem("tipoConta") || localStorage.getItem("role") || "").toLowerCase();
    const empresaId = localStorage.getItem("empresaId");
    if (empresaId) return empresaId;
    if (tipo.includes("empresa")) return localStorage.getItem("userId") || null;
    return null;
  }
  function viewerOwnsVaga(ownerId){
    const owner = ownerId || null;
    const logged = getLoggedEmpresaId();
    if (!owner || !logged) return false;
    return String(logged) === String(owner);
  }

  if (btnEdit){
    btnEdit.addEventListener("click", ()=>{
      const id = new URLSearchParams(location.search).get("id");
      if (!id){ alert("ID da vaga não encontrado."); return; }
      location.href = `criacao_vagas.html?modo=editar&id=${encodeURIComponent(id)}`;
    });
  }

  const confirmModal     = document.getElementById("confirmDelete");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
  if (btnDelete && confirmModal && confirmDeleteBtn){
    btnDelete.addEventListener("click", ()=>{
      if (!vagaId){ alert("ID da vaga não encontrado."); return; }
      openModal(confirmModal);
    });
    confirmDeleteBtn.addEventListener("click", async ()=>{
      const token = localStorage.getItem("token");
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.textContent = "Excluindo...";
      try{
        const resp = await fetch(`/api/vagas/${encodeURIComponent(vagaId)}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "Authorization": `Bearer ${token}` } : {})
          }
        });
        if (!resp.ok){
          const data = await resp.json().catch(()=> ({}));
          throw new Error(data?.error || `Falha ao excluir (HTTP ${resp.status})`);
        }
        closeModal(confirmModal);
        location.href = "vagas.html";
      }catch(err){
        alert(err.message || "Não foi possível excluir a vaga.");
      }finally{
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = "Excluir";
      }
    });
  }

  const el = {
    title:  document.getElementById("jobTitle"),
    company:document.getElementById("companyName"),
    companyCard: document.getElementById("companyProfile"),
    companyAvatar: document.getElementById("companyAvatar"),
    companyLink: document.getElementById("companyLink"),
    desc:   document.getElementById("jobDesc"),
    tags:   document.getElementById("tagsList"),
    turno:  document.getElementById("jobTurno"),
    loc:    document.getElementById("jobLocal"),
    ini:    document.getElementById("jobDateInicio"),
    fim:    document.getElementById("jobDateFim"),
    status: document.getElementById("statusBadge"),
    track:  document.getElementById("carouselTrack"),
    prev:   document.getElementById("prevBtn"),
    next:   document.getElementById("nextBtn"),
  };

  const applyPanel  = document.querySelector(".apply-panel");
  const applyBtnEl  = document.getElementById("applyBtn");
  const applyNoteEl = document.querySelector(".apply-note");

  function isEmpresaAccount(){
    const t = (localStorage.getItem("tipoConta") || localStorage.getItem("role") || "").toLowerCase();
    if (t.includes("empresa")) return true;
    if (localStorage.getItem("empresaId")) return true;
    if (localStorage.getItem("isEmpresa") === "1") return true;
    return false;
  }
  function shouldHideApply(status){
    const s = String(status || "").toUpperCase();
    return ["INSCRICOES_FINALIZADAS","ANDAMENTO","FINALIZADA"].includes(s);
  }
  function updateApplyVisibility(status){
    const hide = isEmpresaAccount() || shouldHideApply(status);
    if (applyPanel)  applyPanel.style.display  = hide ? "none" : "";
    if (applyBtnEl)  applyBtnEl.style.display  = hide ? "none" : "";
    if (applyNoteEl) applyNoteEl.style.display = hide ? "none" : "";
  }
  updateApplyVisibility();

  function resolveImage(src) {
    const FALLBACK = DEFAULT_VAGA_IMG;
    if (!src) return FALLBACK;
    src = String(src).trim().replace(/\\/g, "/");
    if (/^(https?:|data:)/i.test(src)) return src;
    try { src = new URL(src, location.origin).pathname; } catch {}
    src = src.replace(/\/?backend\/(?=uploads\/)/i, "/");
    const p = src.toLowerCase().indexOf("/uploads/");
    if (p !== -1) {
      const rel = src.slice(p);
      return `${API_PREFIX}${rel}`;
    }
    if (/^uploads\//i.test(src)) return `${API_PREFIX}/${src}`;
    return src || FALLBACK;
  }
  function resolveCompanyLogo(src){
    if (!src) return DEFAULT_COMPANY_IMG;
    let clean = String(src).trim().replace(/\\/g,"/");
    if (!clean || clean === "[object Object]") return DEFAULT_COMPANY_IMG;
    if (/^(https?:|data:)/i.test(clean)) return clean;
    clean = clean.replace(/^\/?api\/(?=uploads\/)/i,"/");
    const idx = clean.toLowerCase().indexOf("/uploads/");
    if (idx !== -1){
      const rel = clean.slice(idx);
      return `${API_PREFIX}${rel}`;
    }
    if (/^uploads\//i.test(clean)) return `${API_PREFIX}/${clean}`;
    if (!clean.startsWith("/") && /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(clean)) return `${API_PREFIX}/uploads/${clean}`;
    return clean || DEFAULT_COMPANY_IMG;
  }

  const ensureArray = (x) => Array.isArray(x) ? x : (x ? [x] : []);

  function mapStatus(s){
    switch(s){
      case "ABERTA":                 return {label:"Aberto para inscrição",  cls:"sb-open"};
      case "INSCRICOES_FINALIZADAS": return {label:"Inscrições finalizadas", cls:"sb-inscfin"};
      case "ANDAMENTO":              return {label:"Em andamento",           cls:"sb-run"};
      case "FINALIZADA":             return {label:"Finalizado",             cls:"sb-done"};
      default:                       return {label:"—",                      cls:""};
    }
  }

  function fmtBR(d){
    if (!d) return "—";
    const dt = new Date(d);
    return isNaN(dt) ? "—" : dt.toLocaleDateString("pt-BR");
  }

  function mountCarousel(images){
    let imgs = (Array.isArray(images) ? images : (images ? [images] : []))
      .map(resolveImage)
      .filter(u => typeof u === "string" && u.trim());
    imgs = [...new Set(imgs)];
    if (!imgs.length) imgs = [DEFAULT_VAGA_IMG];

    el.track.innerHTML = "";
    if (el.prev) el.prev.onclick = null;
    if (el.next) el.next.onclick = null;

    for (const src of imgs){
      const img = document.createElement("img");
      img.src = src;
      img.alt = "Imagem da vaga";
      img.loading = "lazy";
      img.onerror = () => { img.src = DEFAULT_VAGA_IMG; };
      el.track.appendChild(img);
    }

    let idx = 0;
    const total = el.track.children.length;
    el.track.style.transform = "translateX(0)";

    const many = total > 1;
    if (el.prev && el.next) {
      el.prev.style.display = many ? "" : "none";
      el.next.style.display = many ? "" : "none";
      if (many) {
        const go = (dir) => {
          idx = (idx + dir + total) % total;
          el.track.style.transform = `translateX(-${idx * 100}%)`;
        };
        el.prev.onclick = () => go(-1);
        el.next.onclick = () => go(+1);
      }
    }
  }

  function updateCompanyProfile(p){
    const nome = p?.empresa || p?.empresaNome || "Empresa";
    if (el.company){
      el.company.textContent = nome || "Empresa";
    }
    if (el.companyAvatar){
      const logoSrc = resolveCompanyLogo(p?.empresaLogo || p?.empresaLogoUrl || p?.logoUrl || p?.logo || "");
      el.companyAvatar.src = logoSrc;
      el.companyAvatar.alt = `Logo de ${nome || "Empresa"}`;
    }
    if (el.companyLink){
      const empresaId = p?.empresaId || p?.empresa?.id || null;
      const perfilUrl = p?.empresaPerfil || (empresaId ? `perfil-empresa.html?id=${encodeURIComponent(empresaId)}${live ? "&public=true" : ""}` : "");
      if (perfilUrl){
        el.companyLink.href = perfilUrl;
        el.companyLink.hidden = false;
      }else{
        el.companyLink.hidden = true;
      }
    }
    if (el.companyCard){
      el.companyCard.hidden = false;
    }
  }

  function applyPreview(p){
    if (!p) return;
    el.title.textContent   = p.titulo || "Vaga";
    updateCompanyProfile(p);
    el.desc.textContent    = p.descricao || "—";
    el.loc.textContent     = p.local || "—";
    el.turno.textContent   = ensureArray(p.turno).join(", ") || "—";
    el.ini.textContent     = fmtBR(p.dataInicio);
    el.fim.textContent     = fmtBR(p.dataFim);

    const s = mapStatus(p.status);
    if (el.status) {
      el.status.textContent = s.label;
      el.status.className = "status-badge " + s.cls;
      el.status.setAttribute("data-status", p.status || "");
    }

    updateApplyVisibility(p.status);

    el.tags.innerHTML = "";
    (p.tags || []).forEach(t=>{
      const b = document.createElement("button");
      b.className = "tag";
      b.textContent = t;
      el.tags.appendChild(b);
    });

    mountCarousel(p.imagens);
  }

  window.addEventListener("message", (ev)=>{
    if (ev?.data?.type === "VAGA_PREVIEW") applyPreview(ev.data.payload);
  });

  function extractOwnerId(v){
    return v?.empresa?.id || v?.empresaId || v?.ownerId || v?.usuarioId || null;
  }

  async function loadVagaReal() {
    if (!vagaId || live) return;
    try {
      const resp = await fetch(`/api/vagas/${vagaId}`);
      if (!resp.ok) throw new Error("vaga não encontrada");
      const v = await resp.json();

      const ownerId = extractOwnerId(v);
      const isOwner = viewerOwnsVaga(ownerId);
      if (btnReport && isOwner) btnReport.style.display = "none";
      if (btnEdit)   btnEdit.style.display   = isOwner ? "" : "none";
      if (btnDelete) btnDelete.style.display = isOwner ? "" : "none";

      let imgs = [];
      if (Array.isArray(v.imagens)) imgs = v.imagens;
      else if (typeof v.imagens === "string") {
        try { const parsed = JSON.parse(v.imagens); imgs = Array.isArray(parsed) ? parsed : (parsed ? [parsed] : []); }
        catch { imgs = v.imagens ? [v.imagens] : []; }
      }
      if (v.capaUrl && !imgs.length) imgs = [v.capaUrl];

      applyPreview({
        titulo: v.titulo,
        empresa: v.empresa?.razao_social,
        empresaId: v.empresa?.id || v.empresaId || extractOwnerId(v),
        empresaLogo: v.empresa?.logoUrl || v.logoUrl || v.empresaLogo,
        descricao: v.descricao,
        tags: v.tags,
        local: v.local,
        turno: v.turno,
        dataInicio: v.dataInicio,
        dataFim: v.dataFim,
        status: v.status,
        imagens: imgs
      });

      if (applyBtnEl) applyBtnEl.dataset.vagaId = v.id || vagaId; // garante o id no botão
    } catch(e){
      console.error(e);
      applyPreview({ imagens: [DEFAULT_VAGA_IMG] });
    }
  }

  // === INTEGRAÇÃO DO BOTÃO "APLICAR" COM O BACKEND ===
  function wireApplyButton(){
    if (!applyBtnEl) return;

    // se veio pelo query, já preenche o data-vaga-id
    if (vagaId && !applyBtnEl.dataset.vagaId) {
      applyBtnEl.dataset.vagaId = vagaId;
    }

    applyBtnEl.addEventListener("click", async () => {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Você precisa estar logado para se candidatar.");
        return;
      }

      const id = applyBtnEl.dataset.vagaId || vagaId;
      if (!id) {
        alert("ID da vaga não encontrado.");
        return;
      }

      // status atual pode esconder o botão; se ainda estiver aparecendo, segue
      applyBtnEl.disabled = true;
      const originalLabel = applyBtnEl.textContent;
      applyBtnEl.textContent = "Enviando...";

      try {
        const resp = await fetch("/api/candidaturas", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ vagaId: id })
        });

        const data = await resp.json().catch(()=> ({}));

        if (!resp.ok) {
          const msg = data?.error || (resp.status === 409 ? "Você já possui candidatura para esta vaga." : "Erro ao enviar candidatura.");
          alert(msg);
          return;
        }

        alert("✅ Candidatura enviada com sucesso!");
        updateApplyVisibility("INSCRICOES_FINALIZADAS"); // opcional: esconde após aplicar
      } catch (err) {
        console.error("Erro ao enviar candidatura:", err);
        alert("❌ Erro ao conectar com o servidor.");
      } finally {
        applyBtnEl.disabled = false;
        applyBtnEl.textContent = originalLabel;
      }
    });
  }

  // helpers mínimos para modais que já existiam
  function openModal(m){ m?.setAttribute("aria-hidden","false"); }
  function closeModal(m){ m?.setAttribute("aria-hidden","true"); }

  loadVagaReal();
  wireApplyButton();
})();
  </script>
  <script src="scripts/notificacoes.js"></script>
</body>
</html>
