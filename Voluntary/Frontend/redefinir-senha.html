<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha - Voluntary</title>
    <link rel="stylesheet" href="css/esqueceu-senha.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Montserrat:wght@400;700&family=Poppins&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
</head>
<body>
    <div class="registro-container">
       <a href="javascript:history.back()" class="btn-voltar">
  <i class="ri-arrow-left-line"></i> Voltar
</a>
        <div class="registro-panel">
            <header class="logo-area">
                <h1 class="logo">Voluntary</h1>
                <p>PORTAL DE VOLUNTARIADO</p>
            </header>

            <form class="registro-form" id="novaSenhaForm">
                <h2>Redefinição de Senha</h2>
                
                <div class="input-group">
                    <input type="password" id="senha" name="senha" placeholder="Nova Senha" required
                        title="8-24 caracteres, com ao menos 1 letra maiúscula, 1 número e 1 símbolo."
                        pattern="^(?=.{8,24}$)(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).*$">
                </div>

                <div id="password-checklist">
                    <ul>
                        <li id="length" class="invalid">Entre 8 e 24 caracteres</li>
                        <li id="upper" class="invalid">Pelo menos uma letra maiúscula</li>
                        <li id="number" class="invalid">Pelo menos um número</li>
                        <li id="symbol" class="invalid">Pelo menos um símbolo</li>
                    </ul>
                </div>

                <div class="input-group">
                    <input type="password" id="confirmarSenha" name="confirmarSenha" placeholder="Confirmar Senha" required>
                </div>

                <p id="erroSenha" style="display: none;">As senhas não coincidem.</p>
                <p id="mensagem" class="mensagem"></p>

                <button id="submitBtn" type="submit">REDEFINIR SENHA</button>
            </form>
        </div>
        <div class="decorative-panel"></div>
    </div>
    
 <script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById("novaSenhaForm");
  const senhaInput = document.getElementById('senha');
  const confirmarInput = document.getElementById('confirmarSenha');
  const lengthCheck = document.getElementById('length');
  const upperCheck = document.getElementById('upper');
  const numberCheck = document.getElementById('number');
  const symbolCheck = document.getElementById('symbol');
  const erro = document.getElementById('erroSenha');
  const mensagem = document.getElementById('mensagem');

  // ✅ Pega os parâmetros da URL (código + email)
  const params = new URLSearchParams(window.location.search);
  const codigo = params.get("codigo");
  const email = params.get("email");

  senhaInput.addEventListener('input', function() {
    const senha = senhaInput.value;
    lengthCheck.className = (senha.length >= 8 && senha.length <= 24) ? 'valid' : 'invalid';
    upperCheck.className = /[A-Z]/.test(senha) ? 'valid' : 'invalid';
    numberCheck.className = /\d/.test(senha) ? 'valid' : 'invalid';
    symbolCheck.className = /[^A-Za-z0-9]/.test(senha) ? 'valid' : 'invalid';
  });

  confirmarInput.addEventListener('input', function() {
    if (confirmarInput.value === senhaInput.value && confirmarInput.value.length > 0) {
      confirmarInput.style.borderColor = 'lime';
      erro.style.display = 'none';
    } else {
      confirmarInput.style.borderColor = '';
      erro.style.display = 'block';
    }
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    if (senhaInput.value !== confirmarInput.value) {
      erro.style.display = 'block';
      return;
    }

    try {
      // ✅ Agora enviamos código + senha
      const resposta = await fetch("/api/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          codigo,
          senha: senhaInput.value
        })
      });

      const data = await resposta.json();

      if (resposta.ok) {
  // Cria popup
  const popup = document.createElement("div");
  popup.classList.add("popup-sucesso");
  popup.innerHTML = `<i class="ri-check-line"></i> Senha redefinida com sucesso!`;

  document.body.appendChild(popup);

  // Mostra com animação
  setTimeout(() => popup.classList.add("mostrar"), 100);

  // Some e redireciona
  setTimeout(() => {
    popup.classList.remove("mostrar");
    setTimeout(() => {
      popup.remove();
      window.location.href = "login.html";
    }, 400);
  }, 2500);
      } else {
        mensagem.textContent = data.error || "Erro ao redefinir senha.";
        mensagem.style.color = "red";
      }
    } catch (err) {
      mensagem.textContent = "Erro de conexão com o servidor.";
      mensagem.style.color = "red";
    }
  });
});
</script>
</body>
</html>
