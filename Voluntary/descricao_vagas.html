<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voluntary — Detalhes da Vaga</title>
  <link rel="stylesheet" href="css/descricao_vagas.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* reforço para cobrir a área toda do carrossel quando o CSS externo ainda não carregou */
    .carousel{position:relative;overflow:hidden;height:300px;display:flex;align-items:center;background:#000}
    @media (max-width: 900px){ .carousel{height:220px} }
    .carousel-track{display:flex;transition:transform .35s ease;height:100%}
    .carousel img{width:100%;height:100%;object-fit:cover;flex:0 0 100%;display:block}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">Voluntary</div>
    <div class="header-actions">
      <button id="notifBtn" class="icon-btn" title="Notificações"><i class="fa-solid fa-bell"></i></button>
      <div class="avatar"><a href="perfil-usuario.html"><img src="img/foto-perfil.png" width="35" height="35" alt="perfil"></a></div>
    </div>
  </header>

  <main class="page">
    <article class="job-card">
      <section class="gallery">
        <div class="carousel" id="carousel">
          <button class="carousel-btn left" id="prevBtn">‹</button>
          <div class="carousel-track" id="carouselTrack"></div>
          <button class="carousel-btn right" id="nextBtn">›</button>
        </div>
      </section>

      <section class="content">
        <div class="content-header">
          <h1 id="jobTitle" class="job-title">Vaga</h1>
          <div id="companyName" class="company">Nome_empresa</div>

          <!-- ações alinhadas à direita -->
          <div class="job-actions">
            <button id="reportBtn" class="btn pill danger">Denunciar</button>
            <button id="editBtn" class="btn pill">Editar vaga</button>
            <button id="deleteBtn" class="btn pill danger-outline">Excluir Vaga</button>
          </div>
        </div>

        <span id="statusBadge" class="status-badge">—</span>

        <p class="job-desc" id="jobDesc">Descrição_vaga</p>

        <div class="meta-row">
          <div class="left-meta">
            <h3>Tags</h3>
            <div class="tags" id="tagsList"></div>

            <div class="info-block">
              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-clock"></i></div>
                <div>
                  <div class="info-title">Horário</div>
                  <div class="info-text"><span id="jobTurno">—</span></div>
                </div>
              </div>

              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-calendar"></i></div>
                <div>
                  <div class="info-title">Período</div>
                  <div class="info-text"><span id="jobDateInicio">—</span> – <span id="jobDateFim">—</span></div>
                </div>
              </div>

              <div class="info-item">
                <div class="icon"><i class="fa-solid fa-map"></i></div>
                <div>
                  <div class="info-title">Localização</div>
                  <div class="info-text" id="jobLocal">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- painel de aplicação no canto -->
        <div class="apply-panel">
          <div class="apply-note">
            Ao clicar no botão de aplicar vaga, os seus dados serão enviados para a empresa
          </div>
          <div class="apply-row">
            <button id="applyBtn" class="apply-btn">Aplicar para a vaga</button>
          </div>
        </div>
      </section>
    </article>

    <aside class="applications" id="applicationsPanel" aria-hidden="true">
      <h4>Candidaturas</h4>
      <ul id="applicationsList"></ul>
      <button id="closeApps" class="small-btn">Fechar</button>
    </aside>
  </main>

  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Denunciar vaga</h3>
      <p>Explique o motivo da denúncia (opcional):</p>
      <textarea id="reportText" rows="5" placeholder="Motivo..."></textarea>
      <div class="modal-actions">
        <button class="small-btn" data-close>Cancelar</button>
        <button class="small-btn primary">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Confirmar exclusão -->
  <div id="confirmDelete" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Excluir vaga</h3>
      <p>Você tem certeza que quer excluir esta vaga? Essa ação não pode ser desfeita.</p>
      <div class="modal-actions">
        <button class="small-btn" data-close>Cancelar</button>
        <button id="confirmDeleteBtn" class="small-btn danger">Excluir</button>
      </div>
    </div>
  </div>

  <script>
(function () {
  const DEFAULT_VAGA_IMG = "img/default-vaga.jpg";
  const API_PREFIX = (typeof window !== "undefined" && window.API_BASE) ? window.API_BASE : "/api";

  const qs = new URLSearchParams(location.search);
  const live = qs.get("live") === "1";
  const vagaId = qs.get("id");
  if (live) document.body.classList.add("live");

// --- botões de ação ---
const btnEdit   = document.getElementById("editBtn");
const btnDelete = document.getElementById("deleteBtn");
const btnReport = document.getElementById("reportBtn");

// 1) Esconde por padrão (evita piscar para não-donos)
[btnEdit, btnDelete].forEach(b => { if (b) b.style.display = "none"; });

// util: pega id do dono da vaga
function getOwnerIdFromVaga(v){
  return v?.empresaId || v?.empresa?.id || v?.ownerId || v?.usuarioId || null;
}
// util: pega id da empresa logada (padrão do seu login_empresa.js)
function getLoggedEmpresaId(){
  // você salva empresaId no login de empresa e remove userId
  return localStorage.getItem("empresaId") || null;
}

// --- EDITAR ---
if (btnEdit){
  btnEdit.addEventListener("click", ()=>{
    const qs = new URLSearchParams(location.search);
    const vagaId = qs.get("id");
    if (!vagaId){ alert("ID da vaga não encontrado."); return; }
    location.href = `criacao_vagas.html?modo=editar&id=${encodeURIComponent(vagaId)}`;
  });
}

// --- EXCLUIR (com confirmação) ---
// (fica como estava)


  // --- EXCLUIR (com confirmação) ---
  const confirmModal     = document.getElementById("confirmDelete");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

  if (btnDelete && confirmModal && confirmDeleteBtn){
    btnDelete.addEventListener("click", ()=>{
      if (!vagaId){ alert("ID da vaga não encontrado."); return; }
      openModal(confirmModal);
    });

    confirmDeleteBtn.addEventListener("click", async ()=>{
      const token = localStorage.getItem("token");
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.textContent = "Excluindo...";
      try{
        const resp = await fetch(`/api/vagas/${encodeURIComponent(vagaId)}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "Authorization": `Bearer ${token}` } : {})
          }
        });
        if (!resp.ok){
          const data = await resp.json().catch(()=> ({}));
          throw new Error(data?.error || `Falha ao excluir (HTTP ${resp.status})`);
        }
        closeModal(confirmModal);
        location.href = "vagas.html"; // ajuste se sua lista tiver outro nome
      }catch(err){
        alert(err.message || "Não foi possível excluir a vaga.");
      }finally{
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = "Excluir";
      }
    });
  }

  // --- elementos de conteúdo ---
  const el = {
    title:  document.getElementById("jobTitle"),
    company:document.getElementById("companyName"),
    desc:   document.getElementById("jobDesc"),
    tags:   document.getElementById("tagsList"),
    turno:  document.getElementById("jobTurno"),
    loc:    document.getElementById("jobLocal"),
    ini:    document.getElementById("jobDateInicio"),
    fim:    document.getElementById("jobDateFim"),
    status: document.getElementById("statusBadge"),
    track:  document.getElementById("carouselTrack"),
    prev:   document.getElementById("prevBtn"),
    next:   document.getElementById("nextBtn"),
  };
  
// elementos do painel de aplicação
const applyPanel  = document.querySelector(".apply-panel");
const applyBtnEl  = document.getElementById("applyBtn");
const applyNoteEl = document.querySelector(".apply-note");

// detecta conta de empresa
function isEmpresaAccount(){
  const t = (localStorage.getItem("tipoConta") || localStorage.getItem("role") || "").toLowerCase();
  if (t.includes("empresa")) return true;
  if (localStorage.getItem("empresaId")) return true;
  if (localStorage.getItem("isEmpresa") === "1") return true;
  return false;
}

// status que escondem o botão
function shouldHideApply(status){
  const s = String(status || "").toUpperCase();
  return ["INSCRICOES_FINALIZADAS","ANDAMENTO","FINALIZADA"].includes(s);
}

// aplica visibilidade
function updateApplyVisibility(status){
  const hide = isEmpresaAccount() || shouldHideApply(status);
  if (applyPanel)  applyPanel.style.display  = hide ? "none" : "";
  if (applyBtnEl)  applyBtnEl.style.display  = hide ? "none" : "";
  if (applyNoteEl) applyNoteEl.style.display = hide ? "none" : "";
}

// estado inicial (antes de carregar a vaga/preview)
updateApplyVisibility();

  function resolveImage(src) {
    const FALLBACK = DEFAULT_VAGA_IMG;
    if (!src) return FALLBACK;
    src = String(src).trim().replace(/\\/g, "/");
    if (/^(https?:|data:)/i.test(src)) return src;
    try { src = new URL(src, location.origin).pathname; } catch {}
    src = src.replace(/\/?backend\/(?=uploads\/)/i, "/");
    const p = src.toLowerCase().indexOf("/uploads/");
    if (p !== -1) {
      const rel = src.slice(p);
      return `${API_PREFIX}${rel}`;
    }
    if (/^uploads\//i.test(src)) return `${API_PREFIX}/${src}`;
    return src || FALLBACK;
  }

  const ensureArray = (x) => Array.isArray(x) ? x : (x ? [x] : []);

  function mapStatus(s){
    switch(s){
      case "ABERTA":                 return {label:"Aberto para inscrição",  cls:"sb-open"};
      case "INSCRICOES_FINALIZADAS": return {label:"Inscrições finalizadas", cls:"sb-inscfin"};
      case "ANDAMENTO":              return {label:"Em andamento",           cls:"sb-run"};
      case "FINALIZADA":             return {label:"Finalizado",             cls:"sb-done"};
      default:                       return {label:"—",                      cls:""};
    }
  }

  function fmtBR(d){
    if (!d) return "—";
    const dt = new Date(d);
    return isNaN(dt) ? "—" : dt.toLocaleDateString("pt-BR");
  }

  function mountCarousel(images){
    let imgs = (Array.isArray(images) ? images : (images ? [images] : []))
      .map(resolveImage)
      .filter(u => typeof u === "string" && u.trim());
    imgs = [...new Set(imgs)];
    if (!imgs.length) imgs = [DEFAULT_VAGA_IMG];

    el.track.innerHTML = "";
    if (el.prev) el.prev.onclick = null;
    if (el.next) el.next.onclick = null;

    for (const src of imgs){
      const img = document.createElement("img");
      img.src = src;
      img.alt = "Imagem da vaga";
      img.loading = "lazy";
      img.onerror = () => { img.src = DEFAULT_VAGA_IMG; };
      el.track.appendChild(img);
    }

    let idx = 0;
    const total = el.track.children.length;
    el.track.style.transform = "translateX(0)";

    const many = total > 1;
    if (el.prev && el.next) {
      el.prev.style.display = many ? "" : "none";
      el.next.style.display = many ? "" : "none";
      if (many) {
        const go = (dir) => {
          idx = (idx + dir + total) % total;
          el.track.style.transform = `translateX(-${idx * 100}%)`;
        };
        el.prev.onclick = () => go(-1);
        el.next.onclick = () => go(+1);
      }
    }
  }

  function applyPreview(p){
    if (!p) return;
    el.title.textContent   = p.titulo || "Vaga";
    el.company.textContent = p.empresa || p.empresaNome || "Empresa";
    el.desc.textContent    = p.descricao || "—";
    el.loc.textContent     = p.local || "—";
    el.turno.textContent   = ensureArray(p.turno).join(", ") || "—";
    el.ini.textContent     = fmtBR(p.dataInicio);
    el.fim.textContent     = fmtBR(p.dataFim);

    const s = mapStatus(p.status);
    if (el.status) {
      el.status.textContent = s.label;
      el.status.className = "status-badge " + s.cls;
    }

    el.tags.innerHTML = "";
    (p.tags || []).forEach(t=>{
      const b = document.createElement("button");
      b.className = "tag";
      b.textContent = t;
      el.tags.appendChild(b);
    });

    mountCarousel(p.imagens);
  }

  // preview ao vivo (iframe)
  window.addEventListener("message", (ev)=>{
    if (ev?.data?.type === "VAGA_PREVIEW") applyPreview(ev.data.payload);
  });

  // detectar dono da vaga (para ocultar "Denunciar")
  function extractOwnerId(v){
    return v?.empresa?.id || v?.empresaId || v?.ownerId || v?.usuarioId || null;
  }

  // carregar vaga real
  async function loadVagaReal() {
    if (!vagaId || live) return;
    try {
      const resp = await fetch(`/api/vagas/${vagaId}`);
      if (!resp.ok) throw new Error("vaga não encontrada");
      const v = await resp.json();

      // esconder "Denunciar" se o usuário logado for o dono
      try{
        const loggedId = localStorage.getItem("userId") || localStorage.getItem("empresaId");
        const ownerId  = extractOwnerId(v);
        if (btnReport && loggedId && ownerId && String(loggedId) === String(ownerId)){
          btnReport.style.display = "none";
        }
      }catch{}

      let imgs = [];
      if (Array.isArray(v.imagens)) imgs = v.imagens;
      else if (typeof v.imagens === "string") {
        try {
          const parsed = JSON.parse(v.imagens);
          imgs = Array.isArray(parsed) ? parsed : (parsed ? [parsed] : []);
        } catch {
          imgs = v.imagens ? [v.imagens] : [];
        }
      }
      if (v.capaUrl && !imgs.length) imgs = [v.capaUrl];

      applyPreview({
        titulo: v.titulo,
        empresa: v.empresa?.razao_social,
        descricao: v.descricao,
        tags: v.tags,
        local: v.local,
        turno: v.turno,
        dataInicio: v.dataInicio,
        dataFim: v.dataFim,
        status: v.status,
        imagens: imgs
      });
    } catch(e){
      console.error(e);
      applyPreview({ imagens: [DEFAULT_VAGA_IMG] });
    }
  }

  loadVagaReal();
})();
  </script>
</body>
</html>
